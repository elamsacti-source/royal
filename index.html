<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELAM Citas | Recepci√≥n Premium üéÑ</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

    <style>
        /* ================= VARIABLES & THEME ================= */
        :root {
            /* Paleta Premium Navidad */
            --primary: #c92a2a;        /* Rojo Intenso */
            --primary-soft: #ffe3e3;   /* Rojo Suave */
            --gold: #fbbf24;           /* Dorado */
            --green: #10b981;          /* Verde Esmeralda */
            --dark: #1e293b;           /* Texto Oscuro */
            --gray: #64748b;           /* Texto Secundario */
            
            /* Fondos */
            --bg-body: #f3f4f6;
            --glass: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.6);
            
            --radius: 16px;
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.08);
            --shadow-hover: 0 20px 40px -10px rgba(0,0,0,0.12);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Outfit', sans-serif; }
        .merry-font { font-family: 'Mountains of Christmas', cursive; font-weight: 700; letter-spacing: 1px; }

        body { 
            background-color: var(--bg-body); 
            background-image: radial-gradient(at 0% 0%, rgba(201, 42, 42, 0.05) 0px, transparent 50%), 
                              radial-gradient(at 100% 100%, rgba(251, 191, 36, 0.1) 0px, transparent 50%);
            color: var(--dark); 
            min-height: 100vh; 
            display: flex; flex-direction: column; font-size: 14px; 
        }

        /* --- UTILIDADES --- */
        .hidden { display: none !important; }
        .flex { display: flex; } .flex-col { flex-direction: column; }
        .gap-2 { gap: 0.5rem; } .gap-3 { gap: 0.75rem; } .gap-4 { gap: 1rem; }
        .w-full { width: 100%; } .mb-3 { margin-bottom: 0.75rem; } .mb-4 { margin-bottom: 1rem; }
        .items-center { align-items: center; } .justify-between { justify-content: space-between; }

        /* --- BOTONES MODERNOS --- */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 0.6rem 1.2rem; border-radius: 12px; font-weight: 600; font-size: 0.9rem; cursor: pointer; border: none; transition: all 0.3s ease; outline: none; position: relative; overflow: hidden; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; } 
        .btn:active { transform: scale(0.98); }
        
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary) 0%, #991b1b 100%); 
            color: white; 
            box-shadow: 0 4px 15px rgba(201, 42, 42, 0.3); 
        }
        .btn-primary:hover { box-shadow: 0 6px 20px rgba(201, 42, 42, 0.4); transform: translateY(-1px); }
        
        .btn-secondary { background: white; border: 1px solid #e2e8f0; color: var(--gray); }
        .btn-secondary:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-soft); }
        
        .btn-icon { padding: 0; width: 36px; height: 36px; border-radius: 10px; flex-shrink: 0; }

        /* --- INPUTS & FORMS --- */
        .input-label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--gray); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select, textarea { 
            width: 100%; padding: 0.6rem 1rem; 
            border-radius: 12px; border: 1px solid #e2e8f0; 
            background: white; color: var(--dark); 
            outline: none; font-size: 0.9rem; height: 42px; 
            transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        textarea { height: auto; } 
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(201, 42, 42, 0.1); transform: translateY(-1px); }
        input[readonly] { background: #f8fafc; color: #94a3b8; cursor: not-allowed; border-style: dashed; }

        /* --- LOGIN SCREEN (DESTELLOS) --- */
        #login-screen { 
            position: fixed; inset: 0; 
            background: linear-gradient(135deg, #7f1d1d 0%, #c92a2a 100%);
            z-index: 1000; display: flex; align-items: center; justify-content: center; 
        }
        /* Patr√≥n de nieve sutil */
        #login-screen::before {
            content: ""; position: absolute; inset: 0; opacity: 0.1;
            background-image: radial-gradient(white 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .login-card { 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); 
            padding: 3rem; border-radius: 24px; 
            width: 90%; max-width: 450px; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); 
            text-align: center; position: relative; border: 1px solid rgba(255,255,255,0.5);
        }
        .logos-wrapper { display: flex; justify-content: center; gap: 20px; margin-bottom: 2rem; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        .logo-auto-contrast { height: 60px; width: auto; filter: invert(1) grayscale(100%) brightness(0); opacity: 0.8; }

        /* --- MAIN LAYOUT --- */
        .main-content { 
            flex: 1; padding: 1.5rem; max-width: 1600px; margin: 0 auto; width: 100%; 
            display: flex; flex-direction: column; gap: 1.5rem; 
        }
        
        /* Barra Superior */
        .top-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--glass); backdrop-filter: blur(10px);
            padding: 1rem 2rem; border-radius: 20px; 
            box-shadow: var(--shadow); border: 1px solid var(--glass-border); 
        }
        
        /* Paneles */
        .grid-layout { display: grid; grid-template-columns: 320px 1fr; gap: 1.5rem; align-items: start; }
        
        .panel { 
            background: white; border-radius: 20px; border: 1px solid #f1f5f9; 
            box-shadow: var(--shadow); display: flex; flex-direction: column; 
            transition: 0.3s; overflow: hidden;
        }
        .panel:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
        
        .panel-header { 
            padding: 1rem 1.5rem; background: linear-gradient(to right, #fff, #fef2f2); 
            border-bottom: 1px solid #f1f5f9; 
            font-weight: 700; font-size: 1rem; display: flex; justify-content: space-between; 
            align-items: center; color: var(--primary); 
        }
        .panel-body { padding: 1.5rem; }

        /* --- ESTAD√çSTICAS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .stat-card { 
            background: white; padding: 1.5rem; border-radius: 20px; 
            box-shadow: var(--shadow); border: 1px solid #f1f5f9; 
            display: flex; align-items: center; gap: 1.2rem; 
            position: relative; overflow: hidden; transition: 0.3s;
        }
        .stat-card:hover { transform: translateY(-3px); }
        
        .stat-icon { 
            width: 50px; height: 50px; border-radius: 14px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.6rem; flex-shrink: 0; z-index: 1;
        }
        .stat-info h3 { font-size: 1.8rem; font-weight: 800; margin: 0; line-height: 1; font-family: 'Outfit', sans-serif; }
        .stat-info p { font-size: 0.85rem; color: var(--gray); margin: 0; font-weight: 500; }
        
        /* Colores Stats */
        .stat-blue .stat-icon { background: #eff6ff; color: #3b82f6; }
        .stat-green .stat-icon { background: #f0fdf4; color: var(--green); }
        .stat-red .stat-icon { background: #fef2f2; color: var(--primary); }
        .stat-purple .stat-icon { background: #f3e8ff; color: #9333ea; }

        /* --- TABLAS ELEGANTES --- */
        .table-container { width: 100%; overflow-x: auto; border-radius: 0 0 20px 20px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.9rem; }
        
        th { 
            text-align: left; padding: 1rem; color: var(--gray); 
            font-weight: 700; background: #f8fafc; border-bottom: 2px solid #e2e8f0; 
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;
            white-space: nowrap; position: sticky; top: 0; z-index: 10;
        }
        td { 
            padding: 1rem; border-bottom: 1px solid #f1f5f9; 
            vertical-align: middle; color: var(--dark); 
            background: white; transition: 0.2s;
        }
        tbody tr:hover td { background-color: #fff1f2; cursor: pointer; }
        tbody tr:last-child td { border-bottom: none; }

        /* Columnas */
        .col-id { width: 50px; text-align: center; color: var(--primary); font-weight: bold; } 
        .col-fecha { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
        
        /* Badges */
        .badge { padding: 6px 12px; border-radius: 30px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; display: inline-block; letter-spacing: 0.5px; }
        .prog { background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; } 
        .atendido { background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; } 
        .cancel { background: #fef2f2; color: #b91c1c; border: 1px solid #fee2e2; }
        .warning { background: #fffbeb; color: #b45309; border: 1px solid #fef3c7; }

        /* --- MODAL --- */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); 
            z-index: 2000; display: none; align-items: center; justify-content: center; 
            backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.3s;
        } 
        .modal-overlay.show { display: flex; opacity: 1; }
        
        .modal { 
            background: white; width: 95%; max-width: 800px; 
            border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); 
            display: flex; flex-direction: column; max-height: 90vh; overflow: hidden; 
            transform: translateY(20px); transition: transform 0.3s;
        }
        .modal-overlay.show .modal { transform: translateY(0); }

        .modal-header { padding: 1.5rem 2rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .modal-body { padding: 2rem; overflow-y: auto; background: #fdfdfd; }
        .modal-footer { padding: 1.5rem 2rem; border-top: 1px solid #e2e8f0; background: #fff; display: flex; justify-content: flex-end; gap: 12px; }
        
        .section-title { font-size: 0.85rem; font-weight: 800; color: var(--primary); text-transform: uppercase; margin: 1.5rem 0 1rem; border-bottom: 2px solid #fecaca; padding-bottom: 6px; display: inline-block; } 
        .section-title:first-child { margin-top: 0; }
        
        .treatment-grid { 
            display: grid; grid-template-columns: 30px 2fr 1.5fr 1fr; gap: 12px; 
            align-items: center; margin-bottom: 10px; background: white; 
            padding: 10px; border-radius: 12px; border: 1px solid #e2e8f0;
        }
        .date-chips { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 4px; margin-left: 42px; margin-bottom: 16px; }
        .date-chip { font-size: 0.75rem; background: white; color: var(--dark); padding: 4px 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* Toast Notifications */
        #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 3000; }
        .toast { 
            background: white; border-left: 5px solid var(--primary); 
            padding: 1rem 1.5rem; border-radius: 12px; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); 
            margin-top: 10px; animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            display: flex; align-items: center; gap: 10px; font-weight: 600;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Media Queries */
        @media (max-width: 1200px) { .grid-layout { grid-template-columns: 1fr; } .main-content { padding: 1rem; } }
        @media (max-width: 768px) { 
            .stats-grid { grid-template-columns: 1fr 1fr; } 
            .flex.gap-4 { flex-direction: column; gap: 0.5rem; } 
            .treatment-grid { grid-template-columns: 1fr; gap: 5px; padding: 15px; } 
            .top-bar { flex-direction: column; gap: 10px; padding: 1rem; }
        }
    </style>
</head>
<body>

    <div style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:0; overflow:hidden;">
        <div style="position:absolute; top:-10px; left:10%; font-size:1.5rem; opacity:0.3; animation:snow 10s linear infinite;">‚ùÑ</div>
        <div style="position:absolute; top:-10px; left:30%; font-size:1rem; opacity:0.2; animation:snow 15s linear infinite; animation-delay:2s;">‚ùÖ</div>
        <div style="position:absolute; top:-10px; left:70%; font-size:2rem; opacity:0.1; animation:snow 12s linear infinite; animation-delay:5s;">‚ùÜ</div>
    </div>
    <style>@keyframes snow{to{transform:translateY(110vh);}}</style>

    <div id="login-screen">
        <div class="login-card">
            
            <div class="logos-wrapper">
                <img src="imagenes/logoIntegra.png" alt="Integra Salud" class="logo-auto-contrast">
                <img src="imagenes/logoLosAngeles.png" alt="Cl√≠nica Los √Ångeles" class="logo-auto-contrast">
            </div>

            <h2 class="merry-font" style="margin-bottom:0.5rem; font-size:2.5rem; color:var(--primary);">Bienvenido</h2>
            <p style="color:var(--gray); font-size:0.95rem; margin-bottom:2rem;">Sistema de Citas - Edici√≥n Navidad üéÑ</p>
            
            <div class="mb-3" style="text-align:left"><label class="input-label">Usuario</label><input type="text" id="user-login" autocomplete="off" placeholder="usuario"></div>
            <div class="mb-4" style="text-align:left; position:relative"><label class="input-label">Contrase√±a</label><input type="password" id="pass-login" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"><i class="ph ph-eye" id="toggle-eye" onclick="togglePasswordVisibility()" style="position:absolute; right:12px; top:32px; cursor:pointer; color:gray; font-size:1.1rem"></i></div>
            <button class="btn btn-primary w-full" onclick="login()" style="padding:0.9rem; font-size:1rem;">Ingresar al Sistema</button>
            <div style="margin-top:20px;"><a href="index.php" style="color:var(--gray); font-size:0.85rem; text-decoration:none; font-weight:500;">‚Üê Volver al Portal Principal</a></div>
        </div>
    </div>

    <div id="app-screen" class="hidden w-full">
        <main class="main-content">
            <div class="top-bar">
                <div class="flex gap-3 items-center">
                    <div class="flex gap-2">
                        <img src="imagenes/logoIntegra.png" class="logo-auto-contrast" style="height:35px">
                        <img src="imagenes/logoLosAngeles.png" class="logo-auto-contrast" style="height:30px">
                    </div>
                    
                    <div style="width: 1px; height: 30px; background: #e2e8f0; margin: 0 10px;"></div>
                    
                    <div>
                        <h1 class="merry-font" style="font-size:1.4rem; color:var(--primary); margin:0; line-height:1;">üéÑ ELAM Citas</h1>
                        <small style="color:var(--gray); font-size:0.75rem;">Panel de Recepci√≥n</small>
                    </div>
                    <div id="sede-badge" style="background:var(--gold); color:#713f12; padding:4px 12px; border-radius:20px; font-size:0.75rem; font-weight:800; box-shadow:0 2px 5px rgba(0,0,0,0.1);">Cargando...</div>
                </div>
                <div class="flex gap-3 items-center">
                    <span id="user-name-display" style="font-weight:600; font-size:0.9rem; color:var(--dark)"></span>
                    <button class="btn btn-secondary btn-icon" onclick="logout()" title="Cerrar Sesi√≥n"><i class="ph ph-sign-out" style="font-size:1.2rem"></i></button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card stat-blue"><div class="stat-icon"><i class="ph ph-calendar"></i></div><div class="stat-info"><h3 id="stat-total">0</h3><p>Hoy</p></div></div>
                <div class="stat-card stat-green"><div class="stat-icon"><i class="ph ph-check-circle"></i></div><div class="stat-info"><h3 id="stat-atendidos">0</h3><p>Atendidos</p></div></div>
                <div class="stat-card stat-red"><div class="stat-icon"><i class="ph ph-x-circle"></i></div><div class="stat-info"><h3 id="stat-cancelados">0</h3><p>Cancelados</p></div></div>
                <div class="stat-card stat-purple"><div class="stat-icon"><i class="ph ph-users-three"></i></div><div class="stat-info"><h3 id="stat-pacientes">0</h3><p>Pacientes</p></div></div>
            </div>

            <div class="grid-layout">
                <div class="flex flex-col gap-4">
                    
                    <div class="panel">
                        <div class="panel-header">
                            <span class="flex items-center gap-2"><i class="ph ph-user text-lg"></i> Datos del Paciente</span>
                            <button class="btn btn-secondary" style="padding:0.3rem 0.8rem; font-size:0.75rem" onclick="limpiarForm('paciente')">Limpiar</button>
                        </div>
                        <div class="panel-body">
                            <div class="flex gap-3 mb-3">
                                <div style="flex:1"><label class="input-label">Doc</label><select id="tipo-doc"><option>DNI</option><option>CE</option></select></div>
                                <div style="flex:2.5"><label class="input-label">N√∫mero</label><div class="flex gap-2"><input id="dni-input" placeholder="8 d√≠gitos"><button class="btn btn-primary btn-icon" id="btn-buscar-dni" onclick="buscarDNI()"><i class="ph ph-magnifying-glass text-lg"></i></button></div></div>
                            </div>
                            <div class="mb-3">
                                <label class="input-label">Apellidos</label>
                                <div class="flex gap-2"><input id="ape-input" readonly placeholder="Paterno Materno"><button class="btn btn-secondary btn-icon" onclick="toggleLock('ape-input', this)"><i class="ph ph-lock-key"></i></button></div>
                            </div>
                            <div class="mb-3">
                                <label class="input-label">Nombres</label>
                                <div class="flex gap-2"><input id="nom-input" readonly placeholder="Nombres Completos"><button class="btn btn-secondary btn-icon" onclick="toggleLock('nom-input', this)"><i class="ph ph-lock-key"></i></button></div>
                            </div>
                            <div class="flex gap-3">
                                <div class="w-full"><label class="input-label">Tel√©fono</label><input id="tel-input"></div>
                                <div class="w-full"><label class="input-label">H. Cl√≠nica</label><input id="hc-input"></div>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-header"><span class="flex items-center gap-2"><i class="ph ph-calendar-plus text-lg"></i> Nueva Cita</span></div>
                        <div class="panel-body">
                            <div class="flex gap-3 mb-3">
                                <div class="w-full"><label class="input-label">Fecha</label><input type="date" id="fecha-cita"></div>
                                <div class="w-full"><label class="input-label">Hora</label><select id="hora-cita"><option>Seleccione...</option></select></div>
                            </div>
                            
                            <div class="mb-3"><label class="input-label">Especialidad</label><select id="esp-cita" onchange="filtrarDoctores()"><option value="">Seleccione...</option></select></div>
                            <div class="mb-3"><label class="input-label">Doctor</label><select id="doc-cita"><option>-- Seleccione --</option></select></div>

                            <div class="flex gap-3 mb-3">
                                <div class="w-full"><label class="input-label">Tipo</label><select id="tipo-cita"><option>Consulta</option><option>Procedimiento</option></select></div>
                                <div class="w-full"><label class="input-label">Consul.</label><select id="consultorio-cita"><option>101</option><option>102</option></select></div>
                            </div>
                            <div class="mb-4">
                                <label class="input-label">Ticket</label>
                                <div style="position:relative">
                                    <i class="ph ph-ticket" style="position:absolute; left:12px; top:12px; color:var(--primary); font-size:1.2rem"></i>
                                    <input id="ticket-input" placeholder="A-01" style="padding-left:40px; font-weight:700; color:var(--primary); letter-spacing:1px;">
                                </div>
                            </div>
                            <button class="btn btn-primary w-full" id="btn-save" onclick="guardarCita()">
                                <i class="ph ph-check-circle text-lg"></i> AGENDAR CITA
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-4">
                    
                    <div class="panel" style="flex:1; min-height:450px">
                        <div class="panel-header">
                            <span class="flex items-center gap-2"><i class="ph ph-hourglass text-lg"></i> Agenda Pendiente</span>
                            <button class="btn btn-secondary btn-icon" onclick="aplicarFiltros()"><i class="ph ph-arrows-clockwise text-lg"></i></button>
                        </div>
                        
                        <div style="padding:1rem; background:#fff; border-bottom:1px solid #f1f5f9; display:grid; grid-template-columns: 1.5fr 1fr 1fr; gap:10px; align-items:end;">
                            <div><label class="input-label">Rango Fechas</label><div style="position:relative"><input id="rango-fechas" placeholder="Seleccionar..." style="padding-left:36px"><i class="ph ph-calendar" style="position:absolute; left:10px; top:10px; color:var(--gray)"></i></div></div>
                            <div><label class="input-label">Especialidad</label><select id="filtro-esp" onchange="cargarDoctoresFiltro()"><option value="">Todas</option></select></div>
                            <div><label class="input-label">Doctor</label><select id="filtro-doc" onchange="aplicarFiltros()"><option value="">Todos</option></select></div>
                        </div>

                        <div class="table-container">
                            <table id="tabla-citas">
                                <thead>
                                    <tr>
                                        <th class="col-id">#</th>
                                        <th class="col-fecha">Fecha</th>
                                        <th>Estado</th>
                                        <th>Paciente</th>
                                        <th>DNI</th>
                                        <th>Tel/HC</th>
                                        <th>Doctor / Esp</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-header"><span class="flex items-center gap-2"><i class="ph ph-check-circle text-lg"></i> Atenciones Finalizadas</span></div>
                        <div class="table-container">
                            <table id="tabla-gestion">
                                <thead>
                                    <tr>
                                        <th class="col-id">#</th>
                                        <th class="col-fecha">Fecha</th>
                                        <th>Estado</th>
                                        <th>Paciente</th>
                                        <th>Triaje</th>
                                        <th>Tel/HC</th>
                                        <th>Doctor / Esp</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="modal-detalle">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <h2 class="merry-font" style="font-size:1.5rem; margin:0; color:var(--primary)">Atender Cita</h2>
                    <p id="modal-paciente-info" style="font-size:0.9rem; color:var(--gray); margin-top:4px;">Cargando paciente...</p>
                </div>
                <button class="btn btn-secondary btn-icon" onclick="closeModal()"><i class="ph ph-x text-lg"></i></button>
            </div>
            
            <div class="modal-body">
                <input type="hidden" id="modal-id">
                
                <div class="section-title">Datos Generales</div>
                <div class="flex gap-4 mb-4" style="flex-wrap:wrap">
                    <div style="flex:1"><label class="input-label">Ticket</label><input id="modal-ticket" style="font-weight:bold;color:var(--primary); text-align:center;"></div>
                    <div style="flex:1"><label class="input-label">H. Cl√≠nica</label><input id="modal-hc"></div>
                    <div style="flex:1.5"><label class="input-label">Estado</label><select id="modal-estado"><option value="ATENDIDO">ATENDIDO</option><option value="CANCELADO">CANCELADO</option><option value="REPROGRAMADO">REPROGRAMADO</option><option value="PROGRAMADO">PROGRAMADO</option></select></div>
                    <div style="flex:1"><label class="input-label">H. Triaje</label><input type="time" id="modal-triaje"></div>
                </div>
                
                <div class="section-title">Derivaciones</div>
                <div style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:1.5rem;">
                    <div class="flex gap-4 mb-3" style="align-items:center; flex-wrap:wrap"><label class="flex gap-2 items-center" style="font-size:0.9rem; font-weight:600;"><input type="checkbox" id="check-re" style="width:18px; height:18px;"> Reconsulta</label><select id="re-esp" style="flex:1"><option value="">Especialidad...</option></select><input type="date" id="re-fecha" style="width:140px"></div>
                    <div class="flex gap-4" style="align-items:center; flex-wrap:wrap"><label class="flex gap-2 items-center" style="font-size:0.9rem; font-weight:600;"><input type="checkbox" id="check-int" style="width:18px; height:18px;"> Interconsulta</label><select id="int-esp" style="flex:1"><option value="">Especialidad...</option></select></div>
                </div>
                
                <div class="section-title">Plan de Tratamiento</div>
                <div class="mb-3"><label class="input-label" style="color:var(--primary)">Inicio de Tratamiento</label><input type="date" id="trat-fecha-ini" onchange="recalculareFechas()"></div>
                
                <div class="treatment-grid" style="background:#f1f5f9; border:none;">
                    <span></span>
                    <span class="input-label" style="margin:0">Producto / Detalle</span>
                    <span class="input-label" style="margin:0">Intervalo</span>
                    <span class="input-label" style="margin:0">Repeticiones</span>
                </div>

                <div class="treatment-grid">
                    <input type="checkbox" id="chk-suple" style="width:18px; height:18px;">
                    <input id="txt-suple-prod" placeholder="Suplementos">
                    <select id="txt-suple-dosis" onchange="calcularFechas('suple')"><option value="">--</option><option value="Diario">Diario</option><option value="Interdiario">Interdiario</option><option value="Semanal">Semanal</option><option value="Quincenal">Quincenal</option><option value="Mensual">Mensual</option><option value="Bimestral">Bimestral</option><option value="Trimestral">Trimestral</option><option value="Semestral">Semestral</option><option value="Anual">Anual</option></select>
                    <select id="txt-suple-frec" onchange="calcularFechas('suple')"><option value="1">x1</option><option value="2">x2</option><option value="3">x3</option></select>
                </div>
                <div id="fechas-suple" class="date-chips"></div>

                <div class="treatment-grid">
                    <input type="checkbox" id="chk-proc" style="width:18px; height:18px;">
                    <input id="txt-proc-prod" placeholder="Procedimiento">
                    <select id="txt-proc-dosis" onchange="calcularFechas('proc')"><option value="">--</option><option value="Diario">Diario</option><option value="Semanal">Semanal</option><option value="Mensual">Mensual</option><option value="Bimestral">Bimestral</option></select>
                    <select id="txt-proc-frec" onchange="calcularFechas('proc')"><option value="1">x1</option><option value="2">x2</option></select>
                </div>
                <div id="fechas-proc" class="date-chips"></div>

                <div class="treatment-grid">
                    <input type="checkbox" id="chk-med" style="width:18px; height:18px;">
                    <input id="txt-med-prod" placeholder="Medicamentos">
                    <select id="txt-med-dosis" onchange="calcularFechas('med')"><option value="">--</option><option value="Diario">Diario</option><option value="Semanal">Semanal</option><option value="Mensual">Mensual</option></select>
                    <select id="txt-med-frec" onchange="calcularFechas('med')"><option value="1">x1</option><option value="2">x2</option></select>
                </div>
                <div id="fechas-med" class="date-chips"></div>

                <div class="section-title">Observaciones</div>
                <textarea id="modal-obs" rows="3" placeholder="Notas cl√≠nicas adicionales..." style="resize:none; padding:15px;"></textarea>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarAtencion()"><i class="ph ph-floppy-disk text-lg"></i> Guardar y Finalizar</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        let DB_CITAS=[], DB_GESTION=[], calendar, CURRENT_SEDE=1, ALL_DOCTORS=[];

        function togglePasswordVisibility() {
            const i=document.getElementById('pass-login'), c=document.getElementById('toggle-eye');
            if(i.type==='password'){i.type='text';c.classList.replace('ph-eye','ph-eye-slash')}else{i.type='password';c.classList.replace('ph-eye-slash','ph-eye')}
        }

        async function login() {
            const u=document.getElementById('user-login').value, p=document.getElementById('pass-login').value;
            const btn=document.querySelector('#login-screen .btn'); btn.disabled=true; btn.innerText='Validando...';
            try{
                // CORRECCI√ìN APLICADA: api_login.php espera 'email' y 'password'
                const r=await fetch('api_login.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:u,password:p})});
                const d=await r.json();
                if(d.success){
                    localStorage.setItem('elam_user',JSON.stringify(d));
                    if(d.rol==='admin')window.location.href='admin.html';
                    else{ document.getElementById('login-screen').classList.add('hidden'); document.getElementById('app-screen').classList.remove('hidden'); initApp(); }
                }else alert(d.message || d.error);
            }catch(e){alert('Error red: ' + e.message);}
            finally{btn.disabled=false;btn.innerText='Ingresar al Sistema';}
        }
        function logout(){localStorage.removeItem('elam_user');location.reload();}

        async function initApp() {
            const user = JSON.parse(localStorage.getItem('elam_user'));
            if(user) {
                try {
                    const r = await fetch(`get_sede_actual.php?id=${user.id}`);
                    const d = await r.json();
                    if(d.sede_id) {
                        CURRENT_SEDE = d.sede_id;
                        document.getElementById('sede-badge').innerText = d.nombre || ("Sede: " + CURRENT_SEDE);
                    }
                } catch(e) { console.log("Error detectando sede"); }
                document.getElementById('user-name-display').innerText = user.nombre || 'Usuario';
            }

            document.getElementById('fecha-cita').valueAsDate = new Date();
            generarHorarios();
            cargarDatosPublicos(); 
            
            const hoy = new Date();
            calendar = flatpickr("#rango-fechas", { mode:"range", dateFormat:"Y-m-d", defaultDate:[hoy,hoy], locale:"es", theme:"airbnb", onChange:()=>aplicarFiltros() });
            await aplicarFiltros();
        }

        // --- FORMATO NOMBRE DOCTOR ---
        function formatoDoctor(nombre) {
            if(!nombre) return '-';
            let limpio = nombre.replace(/^Dr\.\s*/i, '').replace(/^Dra\.\s*/i, ''); 
            const partes = limpio.trim().split(/\s+/);
            const cap = (s) => s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
            if (partes.length > 2) return `Dr. ${cap(partes[0])} ${cap(partes[partes.length - 2])}`;
            else if (partes.length === 2) return `Dr. ${cap(partes[0])} ${cap(partes[1])}`;
            else return `Dr. ${cap(partes[0])}`;
        }

        // --- CARGAR DATOS ---
        async function cargarDatosPublicos() {
            try {
                const r = await fetch('public_get_data.php');
                const d = await r.json();
                
                const fills = [document.getElementById('esp-cita'), document.getElementById('filtro-esp'), document.getElementById('re-esp'), document.getElementById('int-esp')];
                fills.forEach(sel => {
                    if(!sel) return;
                    const def = sel.id === 'filtro-esp' ? 'Todas' : 'Seleccione...';
                    sel.innerHTML = `<option value="">${def}</option>`;
                    d.especialidades.forEach(e => sel.add(new Option(e.nombre, e.nombre)));
                });
                ALL_DOCTORS = d.doctores;
            } catch(e) {}
        }

        function filtrarDoctores() {
            const esp = document.getElementById('esp-cita').value;
            const sel = document.getElementById('doc-cita');
            sel.innerHTML = '<option value="">-- Seleccione --</option>';
            
            const filtrados = ALL_DOCTORS.filter(d => d.nombre_esp === esp);
            filtrados.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.nombre_completo;
                opt.text = formatoDoctor(d.nombre_completo);
                sel.appendChild(opt);
            });
        }

        function cargarDoctoresFiltro() {
            const esp = document.getElementById('filtro-esp').value;
            const sel = document.getElementById('filtro-doc');
            sel.innerHTML = '<option value="">Todos</option>';
            
            const filtrados = (esp === '' || esp === 'Todas') ? ALL_DOCTORS : ALL_DOCTORS.filter(d => d.nombre_esp === esp);
            filtrados.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.nombre_completo;
                opt.text = formatoDoctor(d.nombre_completo);
                sel.appendChild(opt);
            });
            aplicarFiltros();
        }

        async function aplicarFiltros() {
            const f=calendar.selectedDates; let i='',n=''; 
            if(f.length>0){i=f[0].toISOString().split('T')[0];n=f.length===2?f[1].toISOString().split('T')[0]:i;}
            
            const esp = document.getElementById('filtro-esp').value;
            const doc = document.getElementById('filtro-doc').value;
            const p=new URLSearchParams({inicio:i, fin:n, esp:esp, doc:doc, sede:CURRENT_SEDE});

            try { 
                const r1=await fetch(`listar_citas.php?${p.toString()}`); DB_CITAS=await r1.json(); renderTableCitas(); 
                const r2=await fetch(`listar_gestion.php?${p.toString()}`); DB_GESTION=await r2.json(); renderTableGestion(); 
                actualizarStats(); 
            } catch(e){ showToast('error','Error listas'); }
        }

        function enviarWhatsApp(d) { 
            if(!d.telefono || d.telefono.length < 9) return; 

            // Solo enviamos los datos, el PHP decide qu√© imagen y texto poner
            const payload = {
                telefono: d.telefono,
                paciente: d.nombres + ' ' + d.apellidos,
                fecha: d.fecha,
                hora: d.hora,
                especialidad: d.especialidad,
                doctor: formatoDoctor(d.doctor_nombre),
                sede_id: CURRENT_SEDE // <--- ESTO ES LA CLAVE (1, 2 o 3)
            };

            fetch('enviar_wsp.php', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(payload)
            }); 
        }

        async function guardarCita() { 
            const selDoc = document.getElementById('doc-cita');
            const docName = selDoc.value !== '-- Seleccione --' ? selDoc.value : '';

            const data={
                ticket:document.getElementById('ticket-input').value, 
                dni:document.getElementById('dni-input').value, 
                apellidos:document.getElementById('ape-input').value, 
                nombres:document.getElementById('nom-input').value, 
                telefono:document.getElementById('tel-input').value, 
                hc:document.getElementById('hc-input').value, 
                fecha:document.getElementById('fecha-cita').value, 
                hora:document.getElementById('hora-cita').value, 
                especialidad:document.getElementById('esp-cita').value, 
                doctor:docName, 
                doctor_nombre:docName,
                tipo:document.getElementById('tipo-cita').value, 
                consultorio:document.getElementById('consultorio-cita').value,
                sede_id: CURRENT_SEDE
            };

            if(!data.ticket||!data.dni)return alert('Datos faltantes');
            
            try{
                const r=await fetch('guardar_cita.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
                const res=await r.json();
                if(res.success){enviarWhatsApp(data);limpiarForm('cita');limpiarForm('paciente');aplicarFiltros();showToast('success','Guardado');}
                else alert(res.message);
            }catch(e){showToast('error','Error red');}
        }

        // --- UTILS ---
        function actualizarStats() { const t=[...DB_CITAS,...DB_GESTION]; document.getElementById('stat-total').innerText=t.length; document.getElementById('stat-atendidos').innerText=t.filter(c=>c.estado==='ATENDIDO').length; document.getElementById('stat-cancelados').innerText=t.filter(c=>c.estado==='CANCELADO').length; document.getElementById('stat-pacientes').innerText=new Set(t.map(c=>c.paciente||c.nom)).size; }
        
        function renderTableCitas() { 
            const tb=document.querySelector('#tabla-citas tbody'); tb.innerHTML=''; 
            DB_CITAS.forEach((c,ix)=>{ 
                const tr=document.createElement('tr'); tr.ondblclick=()=>openModal(c.id); 
                tr.innerHTML=`<td class='col-id'>${ix+1}</td><td class='col-fecha'>${c.fecha}<br><small style='color:var(--gray)'>${c.hora}</small></td><td><span class="badge ${c.estado==='REPROGRAMADO'?'warning':'prog'}">${c.estado}</span></td><td style="font-weight:600; color:var(--dark)">${c.nom}</td><td><span style='background:#f1f5f9; padding:2px 6px; border-radius:4px; font-family:monospace'>${c.dni}</span></td><td>${c.tel||'-'}<br><b>${c.hc||'-'}</b></td><td><b>${formatoDoctor(c.doc)}</b><br><small style="color:var(--gray)">${c.esp}</small></td>`; 
                tb.appendChild(tr); 
            }); 
        }
        
        function renderTableGestion() { 
            const tb=document.querySelector('#tabla-gestion tbody'); tb.innerHTML=''; 
            DB_GESTION.forEach((g,ix)=>{ 
                const tr=document.createElement('tr'); 
                tr.innerHTML=`<td class='col-id'>${ix+1}</td><td class='col-fecha'>${g.fecha}<br><small style='color:var(--gray)'>${g.hora}</small></td><td><span class="badge ${g.estado==='ATENDIDO'?'atendido':'cancel'}">${g.estado}</span></td><td style="font-weight:600; color:var(--dark)">${g.paciente}</td><td>${g.triaje}</td><td>${g.tel||'-'}<br><b>${g.hc||'-'}</b></td><td><b>${formatoDoctor(g.doc)}</b><br><small style="color:var(--gray)">${g.esp}</small></td>`; 
                tb.appendChild(tr); 
            }); 
        }

        function generarHorarios() { const s=document.getElementById('hora-cita'); s.innerHTML=''; let st=8*60; while(st<=22*60){const h=Math.floor(st/60),m=st%60,t=`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;s.add(new Option(t,t));st+=15;}}
        function toggleLock(id,b){const e=document.getElementById(id);if(e.hasAttribute('readonly')){e.removeAttribute('readonly');b.querySelector('i').classList.replace('ph-lock-key','ph-lock-key-open');e.focus();}else{e.setAttribute('readonly',true);b.querySelector('i').classList.replace('ph-lock-key-open','ph-lock-key');}}
        async function buscarDNI() { const d=document.getElementById('dni-input').value; if(d.length!==8)return; try{const r=await fetch(`proxy.php?dni=${d}`);const j=await r.json();const i=j.data||j;if(i.nombres){document.getElementById('nom-input').value=i.nombres;document.getElementById('ape-input').value=(i.apellido_paterno+' '+i.apellido_materno).trim();}}catch(e){} }
        
        function openModal(id) {
            const c=DB_CITAS.find(x=>x.id==id); if(!c)return;
            document.getElementById('modal-id').value=id; document.getElementById('modal-paciente-info').innerText=`${c.nom}`;
            document.getElementById('modal-ticket').value=c.ticket; document.getElementById('modal-hc').value=c.hc; document.getElementById('modal-estado').value='ATENDIDO'; document.getElementById('modal-triaje').value='';
            ['chk-suple','chk-proc','chk-med','check-re','check-int'].forEach(k=>document.getElementById(k).checked=false);
            ['txt-suple-prod','txt-suple-dosis','txt-suple-frec','txt-proc-prod','txt-proc-dosis','txt-proc-frec','txt-med-prod','txt-med-dosis','txt-med-frec','re-esp','re-fecha','int-esp','modal-obs'].forEach(k=>document.getElementById(k).value='');
            ['fechas-suple','fechas-proc','fechas-med'].forEach(k=>document.getElementById(k).innerHTML='');
            document.getElementById('trat-fecha-ini').value=c.fecha;
            document.getElementById('modal-detalle').classList.add('show');
        }
        function closeModal(){ document.getElementById('modal-detalle').classList.remove('show'); }
        async function guardarAtencion() {
            const b={cita_id:document.getElementById('modal-id').value,estado:document.getElementById('modal-estado').value,ticket:document.getElementById('modal-ticket').value,hc:document.getElementById('modal-hc').value,triaje:document.getElementById('modal-triaje').value,obs:document.getElementById('modal-obs').value,re_check:document.getElementById('check-re').checked,re_esp:document.getElementById('re-esp').value,re_fecha:document.getElementById('re-fecha').value,int_check:document.getElementById('check-int').checked,int_esp:document.getElementById('int-esp').value,trat_fecha_ini:document.getElementById('trat-fecha-ini').value,suple_check:document.getElementById('chk-suple').checked,suple_prod:document.getElementById('txt-suple-prod').value,suple_dosis:document.getElementById('txt-suple-dosis').value,suple_frec:document.getElementById('txt-suple-frec').value,suple_fechas:document.getElementById('fechas-suple').dataset.fechas||'',proc_check:document.getElementById('chk-proc').checked,proc_prod:document.getElementById('txt-proc-prod').value,proc_dosis:document.getElementById('txt-proc-dosis').value,proc_frec:document.getElementById('txt-proc-frec').value,proc_fechas:document.getElementById('fechas-proc').dataset.fechas||'',med_check:document.getElementById('chk-med').checked,med_prod:document.getElementById('txt-med-prod').value,med_dosis:document.getElementById('txt-med-dosis').value,med_frec:document.getElementById('txt-med-frec').value,med_fechas:document.getElementById('fechas-med').dataset.fechas||''};try{const r=await fetch('guardar_atencion.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)});const d=await r.json();if(d.success){closeModal();aplicarFiltros();showToast('success','Finalizado');}else alert(d.message);}catch(e){}}
        function recalculareFechas(){calcularFechas('suple');calcularFechas('proc');calcularFechas('med');}
        function calcularFechas(t){const ini=document.getElementById('trat-fecha-ini').value,inv=document.getElementById(`txt-${t}-dosis`).value,cnt=parseInt(document.getElementById(`txt-${t}-frec`).value)||0,con=document.getElementById(`fechas-${t}`);con.innerHTML='';if(!ini||!inv||cnt<1)return;let base=new Date(ini+'T00:00:00'),gens=[];for(let i=1;i<=cnt;i++){let n=new Date(base);if(inv==='Diario')n.setDate(base.getDate()+(1*i));else if(inv==='Interdiario')n.setDate(base.getDate()+(2*i));else if(inv==='Semanal')n.setDate(base.getDate()+(7*i));else if(inv==='Quincenal')n.setDate(base.getDate()+(15*i));else if(inv==='Mensual')n.setMonth(base.getMonth()+(1*i));else if(inv==='Bimestral')n.setMonth(base.getMonth()+(2*i));else if(inv==='Trimestral')n.setMonth(base.getMonth()+(3*i));else if(inv==='Semestral')n.setMonth(base.getMonth()+(6*i));else if(inv==='Anual')n.setFullYear(base.getFullYear()+(1*i));const iso=n.toISOString().split('T')[0];gens.push(iso);const sp=document.createElement('span');sp.className='date-chip';sp.innerText=iso;con.appendChild(sp);}con.dataset.fechas=gens.join(',');}
        function showToast(t,m){const d=document.createElement('div');d.className='toast';d.innerHTML=`<span>${m}</span>`;d.style.borderLeftColor=t==='error'?'#ef4444':'#10b981';document.getElementById('toast-container').appendChild(d);setTimeout(()=>d.remove(),3000);}
        function limpiarForm(t){if(t==='paciente')['dni-input','ape-input','nom-input','tel-input','hc-input'].forEach(i=>document.getElementById(i).value='');else{document.getElementById('ticket-input').value='';document.getElementById('esp-cita').value='';}}
    </script>
</body>
</html>