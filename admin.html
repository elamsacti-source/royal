<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ELAM | Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root { --primary:#1e293b; --accent:#3b82f6; --bg:#f8fafc; --white:#fff; --border:#e2e8f0; --danger:#ef4444; --success:#10b981; }
        body { font-family:'Inter',sans-serif; background:var(--bg); margin:0; display:flex; height:100vh; }
        .hidden { display: none !important; }
        .sidebar { width:260px; background:var(--primary); color:white; padding:1.5rem; display:flex; flex-direction:column; }
        .brand { font-size:1.2rem; font-weight:700; margin-bottom:2rem; display:flex; align-items:center; gap:10px; }
        .menu button { background:none; border:none; width:100%; text-align:left; font-size:1rem; display:flex; align-items:center; gap:10px; padding:12px; color:#94a3b8; cursor:pointer; border-radius:8px; margin-bottom:5px; transition:0.2s; }
        .menu button:hover, .menu button.active { background:rgba(255,255,255,0.1); color:white; }
        .content { flex:1; padding:2rem; overflow-y:auto; }
        .card { background:var(--white); padding:1.5rem; border-radius:12px; border:1px solid var(--border); margin-bottom:2rem; box-shadow:0 4px 6px -1px rgba(0,0,0,0.05); }
        .grid-form { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; margin-top:1rem; }
        input, select { width:100%; padding:0.6rem; border:1px solid var(--border); border-radius:8px; outline:none; }
        label { display:block; font-size:0.85rem; font-weight:600; color:#64748b; margin-bottom:5px; }
        .btn-save { background:var(--accent); color:white; border:none; padding:0.7rem 1.5rem; border-radius:8px; cursor:pointer; font-weight:600; margin-top:1rem; }
        .btn-icon { border:none; background:none; cursor:pointer; font-size:1.1rem; }
        .btn-del { color:var(--danger); }
        .btn-view { color:var(--primary); }
        .btn-search { background:var(--accent); color:white; border:none; padding:0 12px; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .btn-add { background:#e0f2fe; color:#0284c7; border:1px solid #0284c7; padding:0.4rem 0.8rem; border-radius:6px; cursor:pointer; font-size:0.8rem; font-weight:600; display:inline-flex; align-items:center; gap:5px; margin-top:10px; }
        .btn-plus { background:var(--success); color:white; border:none; width:40px; border-radius:8px; cursor:pointer; font-size:1.2rem; display:flex; align-items:center; justify-content:center; }
        table { width:100%; border-collapse:collapse; margin-top:1rem; font-size:0.9rem; }
        th { text-align:left; padding:12px; background:#f1f5f9; border-bottom:2px solid var(--border); } td { padding:12px; border-bottom:1px solid var(--border); vertical-align:middle; }
        .badge { padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:700; }
        .rol-admin { background:#fef3c7; color:#b45309; } .rol-usuario { background:#dcfce7; color:#15803d; }
        .badge-sede { background:#e0f2fe; color:#0284c7; padding:4px 8px; border-radius:6px; font-weight:600; font-size:0.8rem; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .horario-box { background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:1.5rem; }
        .schedule-row { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
        .schedule-row select.sch-day { flex: 1; font-weight: 600; }
        .schedule-row input { width: 100px; }
        .btn-remove-row { color: var(--danger); cursor: pointer; font-size: 1.2rem; margin-left: 5px; }
        .grid-precios { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px dashed #e2e8f0; }
        .costo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .check-label { font-size: 0.75rem; color: var(--accent); cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .costo-inputs { display: flex; gap: 5px; }
        input[readonly] { background: #f8fafc; color: #94a3b8; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="brand"><i class="ph ph-shield-check"></i> Admin ELAM</div>
        <div class="menu">
            <button onclick="showView('usuarios')" id="btn-usu" class="active"><i class="ph ph-users"></i> Usuarios</button>
            <button onclick="showView('doctores')" id="btn-doc"><i class="ph ph-stethoscope"></i> Staff M√©dico</button>
            <button onclick="showView('catalogo')" id="btn-cat"><i class="ph ph-tag"></i> Cat√°logo</button>
            <button onclick="showView('sedes')" id="btn-sed"><i class="ph ph-buildings"></i> Sedes</button>
            <button onclick="showView('programacion')" id="btn-prog"><i class="ph ph-calendar-plus"></i> Programaci√≥n (Rotaci√≥n)</button>
            <button onclick="location.href='index.html'" style="margin-top:20px; color:#ef4444"><i class="ph ph-sign-out"></i> Salir</button>
        </div>
    </div>
    <div class="content">
        <div id="view-usuarios">
            <h2>Usuarios del Sistema</h2>
            <div class="card">
                <h3>Crear Usuario</h3>
                <div class="grid-form">
                    <div><label>Nombre</label><input type="text" id="usu-nombre" placeholder="Ej: Mar√≠a P√©rez"></div>
                    <div><label>Usuario</label><input type="text" id="usu-user" placeholder="Ej: mperez"></div>
                    <div><label>Contrase√±a</label><input type="password" id="usu-pass"></div>
                    <div><label>Rol</label><select id="usu-rol"><option value="usuario">Recepcionista</option><option value="admin">Administrador</option></select></div>
                    <div><label>Sede Base</label><select id="usu-sede"></select></div>
                    <div><label>Horario Habitual</label><input type="text" id="usu-horario" placeholder="Ej: Lun-Vie 8am-2pm"></div>
                </div>
                <button class="btn-save" onclick="guardarUsuario()">Crear Usuario</button>
            </div>
            <div class="card"><table><thead><tr><th>Nombre</th><th>Usuario</th><th>Rol</th><th>Sede Base</th><th>Horario</th><th>Acci√≥n</th></tr></thead><tbody id="tb-usuarios"></tbody></table></div>
        </div>
        <div id="view-doctores" class="hidden">
            <h2>Staff M√©dico</h2>
            <div class="card">
                <h3>Nuevo Doctor</h3>
                <div class="grid-form" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:1rem">
                    <div><label>DNI M√©dico</label><div style="display:flex; gap:5px"><input type="text" id="doc-dni" placeholder="8 d√≠gitos"><button class="btn-search" onclick="buscarDNIDoc()"><i class="ph ph-magnifying-glass"></i></button></div></div>
                    <div><label>Nombre Completo</label><input type="text" id="doc-nombre" readonly placeholder="Autocompletado..."></div>
                    <div><label>Especialidad</label><div style="display:flex; gap:5px;"><select id="doc-esp" style="flex:1"></select><button class="btn-plus" onclick="nuevaEspecialidad()" title="Agregar nueva">+</button></div></div>
                    <div><label>CMP</label><input type="text" id="doc-cmp" placeholder="N¬∞ CMP"></div>
                    <div><label>RNE</label><input type="text" id="doc-rne" placeholder="N¬∞ RNE"></div>
                    <div><label>Tel√©fono</label><input type="text" id="doc-tel"></div>
                    <div style="grid-column: span 3;"><label>Cargar CV (PDF)</label><input type="file" id="doc-cv" accept="application/pdf" style="padding:0.5rem; border:1px solid #e2e8f0; width:100%; border-radius:8px; background:#fff"></div>
                </div>
                <button class="btn-save" onclick="guardarDoctor()">Guardar Doctor</button>
            </div>
            <div class="card"><table><thead><tr><th>DNI</th><th>Nombre</th><th>CMP / RNE</th><th>CV</th></tr></thead><tbody id="tb-doctores"></tbody></table></div>
        </div>
        <div id="view-catalogo" class="hidden">
            <h2>Cat√°logo de Servicios</h2>
            <div class="card">
                <h3>Configurar Servicio</h3>
                <div class="grid-form" style="display:block">
                    <div class="grid-3">
                        <div><label>Doctor</label><select id="cat-doc-sel"></select></div>
                        <div><label>Sede</label><select id="cat-sede"></select></div>
                        <div><label>Tipo de Servicio</label><div style="display:flex; gap:5px;"><select id="cat-tipo" style="flex:1"></select><button class="btn-plus" onclick="nuevoTipoServicio()">+</button></div></div>
                    </div>
                    <label>Horario de Atenci√≥n (Referencial)</label>
                    <div class="horario-box">
                        <div id="schedule-list"></div>
                        <div><button type="button" class="btn-add" onclick="addScheduleRow()"><i class="ph ph-plus"></i> Agregar D√≠a/Turno</button></div>
                    </div>
                    <div class="grid-precios">
                        <div><label>P.V.P (Venta S/)</label><input type="number" id="cat-pv" step="0.01" oninput="calcGan()" style="font-weight:700"></div>
                        <div><div class="costo-header"><label style="margin:0">P. Costo (S/)</label><label class="check-label"><input type="checkbox" id="check-porc" onchange="togglePorcentaje()"> Calc %</label></div><div class="costo-inputs"><input type="number" id="cat-porc" placeholder="%" style="width:70px; display:none; border-color:var(--accent)" oninput="calcGan()"><input type="number" id="cat-pc" step="0.01" oninput="calcGan()"></div></div>
                        <div><label>Margen (S/)</label><input type="number" id="cat-gan" readonly style="background:#f1f5f9;color:var(--success);font-weight:bold"></div>
                    </div>
                </div>
                <button class="btn-save" onclick="guardarCatalogo()">Guardar en Cat√°logo</button>
            </div>
            <div class="card"><table><thead><tr><th>Sede</th><th>Tipo</th><th>Doctor</th><th>Horario</th><th>P.V.P</th><th>P.Costo</th><th>Margen</th><th>Acci√≥n</th></tr></thead><tbody id="tb-catalogo"></tbody></table></div>
        </div>
        <div id="view-sedes" class="hidden">
            <h2>Sedes</h2>
            <div class="card">
                <h3>Nueva Sede</h3>
                <div class="grid-form">
                    <div><label>Nombre Sede</label><input type="text" id="sede-nom" placeholder="Ej: Sede Norte"></div>
                    <div><label>Direcci√≥n</label><input type="text" id="sede-dir" placeholder="Av. Principal 123"></div>
                </div>
                <button class="btn-save" onclick="guardarSede()">Crear Sede</button>
            </div>
            <div class="card"><table><thead><tr><th>Sede</th><th>Direcci√≥n</th><th>Acci√≥n</th></tr></thead><tbody id="tb-sedes"></tbody></table></div>
        </div>
        <div id="view-programacion" class="hidden">
            <h2>Gesti√≥n de Turnos (Recepcionistas)</h2>
            <div class="card">
                <h3>Asignar Sede por D√≠a</h3>
                <div class="grid-form">
                    <div><label>Usuario (Recepcionista/Admin)</label><select id="sel-usuario"></select></div>
                    <div><label>Sede Asignada</label><select id="sel-sede"></select></div>
                    <div><label>Fecha</label><input type="date" id="fecha-turno"></div>
                    <div><label>Inicio</label><input type="time" id="hora-inicio" value="08:00"></div>
                    <div><label>Fin</label><input type="time" id="hora-fin" value="18:00"></div>
                </div>
                <button class="btn-save" onclick="guardarTurno()">Asignar Turno</button>
            </div>
            <div class="card">
                <h3>Turnos Activos</h3>
                <table><thead><tr><th>Fecha</th><th>Usuario</th><th>Sede Asignada</th><th>Horario</th><th>Acciones</th></tr></thead><tbody id="tabla-turnos"></tbody></table>
            </div>
        </div>
    </div>

    <script>
        let sedes=[], especialidades=[], doctores=[];

        document.addEventListener('DOMContentLoaded', () => { init(); addScheduleRow(); document.getElementById('fecha-turno').valueAsDate = new Date(); });

        function showView(v) {
            ['usuarios','doctores','catalogo','sedes','programacion'].forEach(i => { document.getElementById('view-'+i).classList.add('hidden'); document.getElementById('btn-'+(i==='programacion'?'prog':(i==='usuarios'?'usu':(i==='doctores'?'doc':(i==='catalogo'?'cat':'sed'))))).classList.remove('active'); });
            document.getElementById('view-'+v).classList.remove('hidden'); const map={'programacion':'btn-prog','usuarios':'btn-usu','doctores':'btn-doc','catalogo':'btn-cat','sedes':'btn-sed'}; document.getElementById(map[v]).classList.add('active');
        }

        function addScheduleRow() {
            const container = document.getElementById('schedule-list'); const div = document.createElement('div'); div.className = 'schedule-row';
            div.innerHTML = `<select class="sch-day"><option value="Lunes">Lunes</option><option value="Martes">Martes</option><option value="Mi√©rcoles">Mi√©rcoles</option><option value="Jueves">Jueves</option><option value="Viernes">Viernes</option><option value="S√°bado">S√°bado</option><option value="Domingo">Domingo</option></select><span>De</span> <input type="time" class="sch-start" value="08:00"><span>a</span> <input type="time" class="sch-end" value="13:00"><i class="ph ph-trash btn-remove-row" onclick="this.parentElement.remove()"></i>`;
            container.appendChild(div);
        }

        function togglePorcentaje() { const chk=document.getElementById('check-porc').checked, inpPorc=document.getElementById('cat-porc'), inpCosto=document.getElementById('cat-pc'); if(chk){inpPorc.style.display='block';inpCosto.setAttribute('readonly',true);inpCosto.style.backgroundColor='#f8fafc';calcGan();}else{inpPorc.style.display='none';inpCosto.removeAttribute('readonly');inpCosto.style.backgroundColor='#fff';} }

        async function init() { await cargarAuxiliares(); cargarUsuarios(); cargarDoctores(); cargarCatalogo(); cargarSedes(); listarTurnos(); }

        async function cargarAuxiliares() {
            const rS=await fetch('admin_sedes_backend.php'); sedes=await rS.json();
            const selS=document.getElementById('usu-sede'), selCatSede=document.getElementById('cat-sede'), selProgSede=document.getElementById('sel-sede');
            selS.innerHTML='<option value="">-- Ninguna --</option>'; selCatSede.innerHTML='<option value="">-- Sede --</option>'; selProgSede.innerHTML='<option value="">-- Sede --</option>';
            sedes.forEach(s=>{selS.add(new Option(s.nombre,s.id));selCatSede.add(new Option(s.nombre,s.id));selProgSede.add(new Option(s.nombre,s.id));});
            
            const rE=await fetch('admin_especialidades.php'); especialidades=await rE.json();
            const selE=document.getElementById('doc-esp'); selE.innerHTML='<option value="">-- Especialidad --</option>';
            especialidades.forEach(e=>selE.add(new Option(e.nombre,e.id)));
            
            cargarTiposServicio();
        }
        
        async function cargarTiposServicio() { try{const r=await fetch('admin_tipos_backend.php');const d=await r.json();const sel=document.getElementById('cat-tipo');sel.innerHTML='<option value="">-- Tipo --</option>';d.forEach(t=>sel.add(new Option(t.nombre,t.id)));}catch(e){} }
        async function nuevoTipoServicio() { const n=prompt("Nuevo tipo:"); if(n){await fetch('admin_tipos_backend.php',{method:'POST',body:JSON.stringify({nombre:n})});cargarTiposServicio();} }
        async function nuevaEspecialidad() { const n=prompt("Nueva Especialidad:"); if(n){await fetch('admin_especialidades.php',{method:'POST',body:JSON.stringify({nombre:n})});cargarAuxiliares();} }

        // CRUD FUNCTIONS
        async function cargarUsuarios() { const r=await fetch('admin_usuarios_backend.php'); const d=await r.json(); const tb=document.getElementById('tb-usuarios'); tb.innerHTML=''; const selP=document.getElementById('sel-usuario'); selP.innerHTML='<option>-- Personal --</option>'; d.forEach(u=>{ if(u.rol!=='admin')selP.add(new Option(u.nombre_completo,u.id)); tb.innerHTML+=`<tr><td>${u.nombre_completo}</td><td>${u.usuario}</td><td><span class="badge ${u.rol==='admin'?'rol-admin':'rol-usuario'}">${u.rol}</span></td><td>${u.nombre_sede||'-'}</td><td>${u.horario_referencial||'-'}</td><td><button onclick="borrar('delete_user',${u.id})" class="btn-icon btn-del"><i class="ph ph-trash"></i></button></td></tr>`; }); }
        async function guardarUsuario() { const d={nombre:document.getElementById('usu-nombre').value, user:document.getElementById('usu-user').value, pass:document.getElementById('usu-pass').value, rol:document.getElementById('usu-rol').value, sede:document.getElementById('usu-sede').value, horario:document.getElementById('usu-horario').value}; await fetch('admin_usuarios_backend.php',{method:'POST',body:JSON.stringify(d)}); alert('Guardado'); cargarUsuarios(); }

        async function buscarDNIDoc() { const dni=document.getElementById('doc-dni').value; if(dni.length!==8)return alert("DNI 8 d√≠gitos"); try{const r=await fetch(`proxy.php?dni=${dni}`);const d=await r.json();const info=d.data||d;if(info.nombres)document.getElementById('doc-nombre').value=`${info.nombres} ${info.apellido_paterno} ${info.apellido_materno}`;else alert("No encontrado");}catch(e){alert("Error buscar");} }
        async function cargarDoctores() { const r=await fetch('admin_doctores_backend.php'); doctores=await r.json(); const tb=document.getElementById('tb-doctores'); tb.innerHTML=''; const selC=document.getElementById('cat-doc-sel'); selC.innerHTML='<option value="">-- Seleccione --</option>'; doctores.forEach(doc=>{ let cvBtn=doc.cv_path?`<a href="${doc.cv_path}" target="_blank" class="btn-view"><i class="ph ph-eye"></i> Ver CV</a>`:'<span style="color:#ccc">-</span>'; tb.innerHTML+=`<tr><td>${doc.dni||'-'}</td><td>${doc.nombre_completo}</td><td>CMP:${doc.cmp||'-'} RNE:${doc.rne||'-'}</td><td>${cvBtn}</td></tr>`; selC.add(new Option(doc.nombre_completo, doc.id)); }); }
        async function guardarDoctor() { const fd=new FormData(); fd.append('dni',document.getElementById('doc-dni').value); fd.append('nombre',document.getElementById('doc-nombre').value); fd.append('esp_id',document.getElementById('doc-esp').value); fd.append('tel',document.getElementById('doc-tel').value); fd.append('cmp',document.getElementById('doc-cmp').value); fd.append('rne',document.getElementById('doc-rne').value); const fi=document.getElementById('doc-cv'); if(fi.files.length>0)fd.append('cv',fi.files[0]); if(!document.getElementById('doc-esp').value)return alert("Falta Especialidad"); await fetch('admin_doctores_backend.php',{method:'POST',body:fd}); alert('Guardado'); cargarDoctores(); }

        function calcGan(){ const pv=parseFloat(document.getElementById('cat-pv').value)||0; const isPerc=document.getElementById('check-porc').checked; if(isPerc){const porc=parseFloat(document.getElementById('cat-porc').value)||0;document.getElementById('cat-pc').value=(pv*(porc/100)).toFixed(2);} const pc=parseFloat(document.getElementById('cat-pc').value)||0; document.getElementById('cat-gan').value=(pv-pc).toFixed(2); }
        async function cargarCatalogo() { const r=await fetch('admin_catalogo_backend.php?action=list'); const d=await r.json(); const tb=document.getElementById('tb-catalogo'); tb.innerHTML=''; d.forEach(c=>{ let hor=c.horario_referencial?c.horario_referencial.replace(/\|/g,'<br>'):'-'; tb.innerHTML+=`<tr><td><b>${c.sede_nombre||'-'}</b></td><td>${c.tipo_nombre||'-'}<br><small style="color:gray">${c.esp_nombre}</small></td><td>${c.doc_nombre}<br><small style="color:#64748b">üìû ${c.doc_tel||'-'}</small></td><td style="font-size:0.85rem;line-height:1.4">${hor}</td><td>S/${c.precio_venta}</td><td>S/${c.precio_costo}</td><td style="color:var(--success);font-weight:bold">S/${c.ganancia}</td><td><button class="btn-icon btn-del" onclick="delCat(${c.id})"><i class="ph ph-trash"></i></button></td></tr>`; }); }
        async function guardarCatalogo() { let hArr=[]; document.querySelectorAll('.schedule-row').forEach(r=>{ const d=r.querySelector('.sch-day').value, i=r.querySelector('.sch-start').value, f=r.querySelector('.sch-end').value; hArr.push(`<b>${d}:</b> ${i} - ${f}`); }); const d={action:'create', doc_id:document.getElementById('cat-doc-sel').value, sede:document.getElementById('cat-sede').value, tipo_id:document.getElementById('cat-tipo').value, hor:hArr.join(' | '), pv:document.getElementById('cat-pv').value, pc:document.getElementById('cat-pc').value, gan:document.getElementById('cat-gan').value}; if(!d.doc_id||!d.pv||!d.sede)return alert("Faltan datos"); await fetch('admin_catalogo_backend.php',{method:'POST',body:JSON.stringify(d)}); alert('Guardado'); cargarCatalogo(); document.getElementById('schedule-list').innerHTML=''; addScheduleRow(); }
        async function delCat(id){ if(confirm('Borrar?')) await fetch('admin_catalogo_backend.php',{method:'POST',body:JSON.stringify({action:'delete',id})}); cargarCatalogo(); }

        async function cargarSedes() { const r=await fetch('admin_sedes_backend.php'); const d=await r.json(); const tb=document.getElementById('tb-sedes'); tb.innerHTML=''; d.forEach(s=>tb.innerHTML+=`<tr><td>${s.nombre}</td><td>${s.direccion}</td><td><button class="btn-icon btn-del" onclick="borrar('delete_sede',${s.id})"><i class="ph ph-trash"></i></button></td></tr>`); }
        async function guardarSede() { const d={nombre:document.getElementById('new-sede-nombre').value, direccion:document.getElementById('new-sede-dir').value}; await fetch('admin_sedes_backend.php',{method:'POST',body:JSON.stringify(d)}); alert('Guardado'); cargarSedes(); }

        async function guardarTurno() { const d={usuario:document.getElementById('sel-usuario').value, sede:document.getElementById('sel-sede').value, fecha:document.getElementById('fecha-turno').value, inicio:document.getElementById('hora-inicio').value, fin:document.getElementById('hora-fin').value}; if(!d.usuario||!d.sede)return alert("Datos incompletos"); await fetch('admin_guardar_turno.php',{method:'POST',body:JSON.stringify(d)}); alert('Asignado'); listarTurnos(); }
        async function listarTurnos() { const r=await fetch('admin_listar_turnos.php'); const d=await r.json(); const tb=document.getElementById('tabla-turnos'); tb.innerHTML=''; d.forEach(t=>tb.innerHTML+=`<tr><td>${t.fecha}</td><td>${t.medico}</td><td><span class="badge-sede">${t.sede}</span></td><td>${t.hora_inicio}-${t.hora_fin}</td><td><button class="btn-icon btn-del" onclick="borrar('delete_turno',${t.id})"><i class="ph ph-trash"></i></button></td></tr>`); }

        async function borrar(action, id) { if(!confirm("¬øEliminar?"))return; const r=await fetch('admin_actions.php',{method:'POST',body:JSON.stringify({action,id})}); const d=await r.json(); if(d.success){alert("Eliminado");init();}else alert(d.message); }
    </script>
</body>
</html>